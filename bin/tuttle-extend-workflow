#!/usr/bin/env python
# -*- coding: utf8 -*-

import sys
from jinja2.environment import Environment
from jinja2.exceptions import UndefinedError
from jinja2.loaders import FileSystemLoader
from jinja2.runtime import StrictUndefined
from os.path import abspath, exists, dirname, join
if getattr(sys, 'frozen', False):
    # frozen
    tuttle_module = join(dirname(abspath(sys.executable)), '..', '..', 'tuttle')
else:
    # unfrozen
    tuttle_module = join(dirname(abspath(__file__)), '..', '..', 'tuttle')
sys.path.insert(0,tuttle_module)

from argparse import ArgumentParser
from tuttle.utils import CurrentDir
from tuttle.version import version
from os import environ


class ExtendError(Exception):
    pass


def get_a_name(prefix):
    # TODO : not scalable if called a lot of times
    i = 1
    name = abspath(join('extensions', "{}{}".format(prefix, i)))
    while exists(name):
        name = abspath(join('extensions', "{}{}".format(prefix, i)))
        i += 1
    return name


def extract_variables(variables):
    res = {}
    for var in variables:
        try:
            name, value = var.split("=", 2)
        except ValueError:
            msg = 'Can\'t extract variable from parameter "{}"'.format(var)
            raise ExtendError(msg)
        res[name] = value
    return res


def load_template(template):
    try:
        jinja_env = Environment(loader=FileSystemLoader("."), undefined=StrictUndefined)
        t = jinja_env.get_template(template)
    except IOError:
        msg = 'Can\'t find template file "{}"'.format(template)
        raise ExtendError(msg)
    return t


def get_tuttle_env(env_vars):
    try:
        env = env_vars['TUTTLE_ENV']
    except KeyError:
        msg = 'Can\'t find workspace... Maybe your are not running tuttle-extend-workflow from a preprocessor in a ' \
              'tuttle project'
        raise ExtendError(msg)
    return env


def render_extension(name, t, tuttle_env, vars_dic):
    with CurrentDir(tuttle_env):
        with open(get_a_name(name), 'w') as ext_file:
            try:
                content = t.render(**vars_dic)
            except UndefinedError as e:
                msg = 'Missing value for a template variable.\n{}'.format(e.message)
                raise ExtendError(msg)
            ext_file.write(content.encode('utf8)'))


def extend_workflow(template, variables, name, env_vars):
    t = load_template(template)
    vars_dic = extract_variables(variables)
    tuttle_env = get_tuttle_env(env_vars)
    render_extension(name, t, tuttle_env, vars_dic)


def main():
    parser = ArgumentParser(
        description="Extends a workflow by adding a templated tuttle project. Must be run from a preprocessor in a "
                    "tuttle project - version {}".format(version)
    )
    parser.add_argument("template", help="template file")
    parser.add_argument('variables', help='variables to insert into the template int the form my_var="my value"',
                        nargs="*")
    parser.add_argument('-n', '--name',
                        default='extension',
                        dest='name',
                        help='Name of the extended workflow')
    params = parser.parse_args()

    try:
        extend_workflow(params.template, params.variables, params.name, environ)
    except ExtendError as e:
        print e.message
        exit(1)


if __name__ == '__main__':
    sys.exit(main())