#!/usr/bin/env python
# -*- coding: utf8 -*-

import sys
from optparse import OptionParser
from tuttle import prepare_workflow, \
                   run_workflow, \
                   abort_if_workflow_inconsistent, \
                   dump_workflow

from os import chdir, getcwd
from os.path import abspath


def parse_options():
    usage = 'bin/tuttle'
    parser = OptionParser(usage=usage)
    parser.add_option('-p', '--project',
                  default='tuttlefile',
                  dest='tuttlefile',
                  help='Path to the tuttlefile : file describing the workflow')
    parser.add_option('-w', '--workspace',
                  default='.',
                  dest='workspace',
                  help='Directory where the workspace lies. Default is the current directory')
    options, _ = parser.parse_args()
    return options

def main():
    """Main entry point for the project."""

    options = parse_options()
    current_dir = getcwd()
    tuttlefile_path = abspath(options.tuttlefile)
    chdir(options.workspace)
    try:
        workflow = prepare_workflow(tuttlefile_path)
        if not workflow:
            return
        if abort_if_workflow_inconsistent(workflow):
            return
        run_workflow(workflow)
        dump_workflow(workflow)
    finally:
        chdir(current_dir)


if __name__ == '__main__':
    sys.exit(main())